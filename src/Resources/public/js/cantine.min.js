'use strict';jQuery("document").ready(function(a){let m=function(){console.clear();console.log("Maj de la liste des Repas");let d={action:"getListeRepas",date:a("input#date").val()};""!=a("select#nomClasse").val()&&(d.classe=a("select#nomClasse").val());""!=a("select#nomEtablissement").val()&&(d.etablissement=a("select#nomEtablissement").val());a.ajax({url:"/ajax.html",data:d,type:"POST",success:function(b){b=a.parseJSON(b);"error"==b.result?alert("Erreur Ajax : "+b.details.msg):(a("#presences tbody tr").hide(),
0==b.data.length&&alert("Aucun enfant trouv\u00e9"),b.data.forEach(c=>{let e="#matin_"+c.enfant,f="#midi_"+c.enfant,h="#soir_"+c.enfant;a("#enfant_"+c.enfant).show("slow");a(e).prop("checked","1"==c.matin?!0:!1);a(f).prop("checked","1"==c.midi?!0:!1);a(h).prop("checked","1"==c.soir?!0:!1)}))},error:function(b){console.error(b)}})};a("select#nomClasse, select#nomEtablissement, input#date").change(function(){m()});if(0<a("input#date").length){let d=(new Date).toISOString().slice(0,10);document.getElementById("date").value=
d}0<a("table#datatable").length&&new DataTable("#datatable",{lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]});a("#sendFactures").on("click",function(d){d.preventDefault();let b=70,c=0,e=0,f=0;Swal.fire({icon:"question",text:"Quels type de mails souhaitez vous envoyer avec les factures coch\u00e9es ci-dessus ?",input:"select",inputOptions:{nouveau:"Nouvelle facture",relance:"Relance de facture impay\u00e9"},confirmButtonText:"Envoyer",showCancelButton:!0,cancelButtonText:"Annuler",showLoaderOnConfirm:!0}).then(h=>
{if(1==h.isConfirmed){let k=a("input.factures:checked");b=k.length;a(".state span")[1].innerText=b;a("#envoiEnCours").show();(async function(){return new Promise((n,p)=>{for(let g=0;g<b;g++)a.ajax({url:"/ajax.html",data:{action:"sendMailFacture",item:k[g].value,typeMail:h.value},type:"POST",success:function(l){"error"==a.parseJSON(l).result?(a(k[g]).closest("tr").css("background","#e98080"),f++):(a(k[g]).closest("tr").css("background","#9ed19e"),e++);c++;l=100*c/b+"%";a(".progress span").css("width",
l);a(".state span")[0].innerText=c;e+f==b&&n()}})})})().then(()=>{Swal.fire({title:"Envois termin\u00e9s",html:`${e} r\u00e9ussite(s) pour ${f} \u00e9chec(s)`});a("#envoiEnCours").hide()})}})});a("a.paiement").on("click",function(d){d.preventDefault();let b=d.delegateTarget.href.match(/id=([^&]*)/)[1];Swal.fire({icon:"question",title:"Date et type de paiement ?",html:'<input type="date" id="date" class="swal2-input" placeholder="date du paiement"><br/>\n                    <div class="swal2-radio" style="display: flex;"><label><input type="radio" name="swal2-radio" value="esp"><span class="swal2-label">Esp\u00e8ce</span></label>\n                    <label><input type="radio" name="swal2-radio" value="chk"><span class="swal2-label">Ch\u00e8que</span></label>\n                    <label><input type="radio" name="swal2-radio" value="vir"><span class="swal2-label">Virement</span></label></div>',
preConfirm:()=>{let c=Swal.getPopup().querySelector("#date").value,e=Swal.getPopup().querySelector("input[name=swal2-radio]:checked").value;c&&e||Swal.showValidationMessage("Merci de renseigner tous les champs");return{date:c,paiement:e}},confirmButtonText:"Valider"}).then(c=>{1==c.isConfirmed&&a.ajax({url:"/ajax.html",data:{action:"majPaiement",item:b,date:c.value.date,choix:c.value.paiement},type:"POST",success:function(e){e=a.parseJSON(e);"error"==e.result?(alert("Erreur lors du paiement"),console.error(e)):
0<a("form#genFacture").length?a("form#genFacture").submit():document.location.href=document.location.href}})})});a("form#genFacture input[name=dateDebut]").on("change",function(){let d=moment(this.value),b=moment(this.value);d.date(1);b.endOf("month");this.value=d.format("YYYY-MM-DD");a("input[name=dateFin]").val(b.format("YYYY-MM-DD"))})});