'use strict';jQuery("document").ready(function(a){let n=function(){console.clear();console.log("Maj de la liste des Repas");let d={action:"getListeRepas",date:a("input#date").val()};""!=a("select#nomClasse").val()&&(d.classe=a("select#nomClasse").val());""!=a("select#nomEtablissement").val()&&(d.etablissement=a("select#nomEtablissement").val());a.ajax({url:"/ajax.html",data:d,type:"POST",success:function(c){c=a.parseJSON(c);"error"==c.result?alert("Erreur Ajax : "+c.details.msg):(a("#presences tbody tr").hide(),
0==c.data.length&&alert("Aucun enfant trouv\u00e9"),c.data.forEach(b=>{let e="#matin_"+b.enfant,g="#midi_"+b.enfant,k="#soir_"+b.enfant,f="#absence_"+b.enfant,l="#adhesion_"+b.enfant;a("#enfant_"+b.enfant).show("slow");a(e).prop("checked","1"==b.matin?!0:!1);a(g).prop("checked","1"==b.midi?!0:!1);a(k).prop("checked","1"==b.soir?!0:!1);a(f).prop("checked","1"==b.abs?!0:!1);a(l).prop("checked","1"==b.adh?!0:!1)}))},error:function(c){console.error(c)}})};a("select#nomClasse, select#nomEtablissement, input#date").change(function(){n()});
if(0<a("input#date").length){let d=(new Date).toISOString().slice(0,10);document.getElementById("date").value=d}0<a("table#datatable").length&&new DataTable("#datatable",{lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]});a("#sendFactures").on("click",function(d){d.preventDefault();let c=70,b=0,e=0,g=0;Swal.fire({icon:"question",text:"Quels type de mails souhaitez vous envoyer avec les factures coch\u00e9es ci-dessus ?",input:"select",inputOptions:{nouveau:"Nouvelle facture",relance:"Relance de facture impay\u00e9"},
confirmButtonText:"Envoyer",showCancelButton:!0,cancelButtonText:"Annuler",showLoaderOnConfirm:!0}).then(k=>{if(1==k.isConfirmed){let f=a("input.factures:checked");c=f.length;a(".state span")[1].innerText=c;a("#envoiEnCours").show();(async function(){return new Promise((l,p)=>{for(let h=0;h<c;h++)a.ajax({url:"/ajax.html",data:{action:"sendMailFacture",item:f[h].value,typeMail:k.value},type:"POST",success:function(m){"error"==a.parseJSON(m).result?(a(f[h]).closest("tr").css("background","#e98080"),
g++):(a(f[h]).closest("tr").css("background","#9ed19e"),e++);b++;m=100*b/c+"%";a(".progress span").css("width",m);a(".state span")[0].innerText=b;e+g==c&&l()}})})})().then(()=>{Swal.fire({title:"Envois termin\u00e9s",html:`${e} r\u00e9ussite(s) pour ${g} \u00e9chec(s)`});a("#envoiEnCours").hide()})}})});a("a.paiement").on("click",function(d){d.preventDefault();let c=d.delegateTarget.href.match(/id=([^&]*)/)[1];Swal.fire({icon:"question",title:"Date et type de paiement ?",html:'<input type="date" id="date" class="swal2-input" placeholder="date du paiement"><br/>\n                    <div class="swal2-radio" style="display: flex;"><label><input type="radio" name="swal2-radio" value="esp"><span class="swal2-label">Esp\u00e8ce</span></label>\n                    <label><input type="radio" name="swal2-radio" value="chk"><span class="swal2-label">Ch\u00e8que</span></label>\n                    <label><input type="radio" name="swal2-radio" value="vir"><span class="swal2-label">Virement</span></label></div>',
preConfirm:()=>{let b=Swal.getPopup().querySelector("#date").value,e=Swal.getPopup().querySelector("input[name=swal2-radio]:checked").value;b&&e||Swal.showValidationMessage("Merci de renseigner tous les champs");return{date:b,paiement:e}},confirmButtonText:"Valider"}).then(b=>{1==b.isConfirmed&&a.ajax({url:"/ajax.html",data:{action:"majPaiement",item:c,date:b.value.date,choix:b.value.paiement},type:"POST",success:function(e){e=a.parseJSON(e);"error"==e.result?(alert("Erreur lors du paiement"),console.error(e)):
0<a("form#genFacture").length?a("form#genFacture").submit():document.location.href=document.location.href}})})});a("form#genFacture input[name=dateDebut]").on("change",function(){let d=moment(this.value),c=moment(this.value);d.date(1);c.endOf("month");this.value=d.format("YYYY-MM-DD");a("input[name=dateFin]").val(c.format("YYYY-MM-DD"))})});