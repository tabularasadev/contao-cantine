'use strict';jQuery("document").ready(function(a){let p=function(){console.clear();console.log("Maj de la liste des Repas");a("#loading").show();let b={action:"getListeRepas",date:a("input#date").val()};""!=a("select#nomClasse").val()&&(b.classe=a("select#nomClasse").val());""!=a("select#nomEtablissement").val()&&(b.etablissement=a("select#nomEtablissement").val());a.ajax({url:"/ajax.html",data:b,type:"POST",success:function(d){d=a.parseJSON(d);"error"==d.result?alert("Erreur Ajax : "+d.details.msg):
(a("#presences tbody tr").hide(),0==d.data.length&&alert("Aucun enfant trouv\u00e9"),d.data.forEach(c=>{let e="#matin_"+c.enfant,g="#midi_"+c.enfant,k="#soir_"+c.enfant,f="#absence_"+c.enfant,l="#adhesion_"+c.enfant;a("#enfant_"+c.enfant).show("slow");a(e).prop("checked","1"==c.matin?!0:!1);a(g).prop("checked","1"==c.midi?!0:!1);a(k).prop("checked","1"==c.soir?!0:!1);a(f).prop("checked","1"==c.abs?!0:!1);a(l).prop("checked","1"==c.adh?!0:!1)}),a("#loading").hide())},error:function(d){console.error(d);
a("#loading").hide()}})};a("select#nomClasse, select#nomEtablissement, input#date").change(function(){"NOK"==a("#MODIFNONSAVE").val()?window.confirm("Vous avez des modifications non enregistr\u00e9es, souhaitez-vous continuer ?")&&(a("#MODIFNONSAVE").val("OK"),p()):p()});0<a("table#datatable").length&&new DataTable("#datatable",{lengthMenu:[[10,25,50,-1],[10,25,50,"All"]]});a("input[value=all]").on("click",function(){let b=this.checked,d=this.id.split("_")[0];a("#presences tbody tr").each(function(){if("none"!=
this.style.display){let c=this.id.split("_")[1];document.getElementById(d+"_"+c).checked=b}})});a("input[type=checkbox]").on("change",function(){let b=a("#MODIFNONSAVE")[0];"NOK"!=b.value&&(b.value="NOK")});a("#sendFactures").on("click",function(b){b.preventDefault();let d=70,c=0,e=0,g=0;Swal.fire({icon:"question",text:"Quels type de mails souhaitez vous envoyer avec les factures coch\u00e9es ci-dessus ?",input:"select",inputOptions:{nouveau:"Nouvelle facture",relance:"Relance de facture impay\u00e9"},
confirmButtonText:"Envoyer",showCancelButton:!0,cancelButtonText:"Annuler",showLoaderOnConfirm:!0}).then(k=>{if(1==k.isConfirmed){let f=a("input.factures:checked");d=f.length;a(".state span")[1].innerText=d;a("#envoiEnCours").show();(async function(){return new Promise((l,m)=>{for(let h=0;h<d;h++)m={action:"sendMailFacture",item:f[h].value,typeMail:k.value},console.log(m),a.ajax({url:"/ajax.html",data:m,type:"POST",success:function(n){"error"==a.parseJSON(n).result?(a(f[h]).closest("tr").css("background",
"#e98080"),g++):(a(f[h]).closest("tr").css("background","#9ed19e"),e++);c++;n=100*c/d+"%";a(".progress span").css("width",n);a(".state span")[0].innerText=c;e+g==d&&l()}})})})().then(()=>{Swal.fire({title:"Envois termin\u00e9s",html:`${e} r\u00e9ussite(s) pour ${g} \u00e9chec(s)`});a("#envoiEnCours").hide()})}})});a("a.paiement").on("click",function(b){b.preventDefault();let d=b.delegateTarget.href.match(/id=([^&]*)/)[1];Swal.fire({icon:"question",title:"Date et type de paiement ?",html:'<input type="date" id="date" class="swal2-input" placeholder="date du paiement"><br/>\n                    <div class="swal2-radio" style="display: flex;"><label><input type="radio" name="swal2-radio" value="esp"><span class="swal2-label">Esp\u00e8ce</span></label>\n                    <label><input type="radio" name="swal2-radio" value="chk"><span class="swal2-label">Ch\u00e8que</span></label>\n                    <label><input type="radio" name="swal2-radio" value="vir"><span class="swal2-label">Virement</span></label></div>',
preConfirm:()=>{let c=Swal.getPopup().querySelector("#date").value,e=Swal.getPopup().querySelector("input[name=swal2-radio]:checked").value;c&&e||Swal.showValidationMessage("Merci de renseigner tous les champs");return{date:c,paiement:e}},confirmButtonText:"Valider"}).then(c=>{1==c.isConfirmed&&a.ajax({url:"/ajax.html",data:{action:"majPaiement",item:d,date:c.value.date,choix:c.value.paiement},type:"POST",success:function(e){e=a.parseJSON(e);"error"==e.result?(alert("Erreur lors du paiement"),console.error(e)):
0<a("form#genFacture").length?a("form#genFacture").submit():document.location.href=document.location.href}})})});a("form#genFacture input[name=dateDebut]").on("change",function(){let b=moment(this.value),d=moment(this.value);b.date(1);d.endOf("month");this.value=b.format("YYYY-MM-DD");a("input[name=dateFin]").val(d.format("YYYY-MM-DD"))});a("#saisieEnfants").on("submit",function(b){a("#loading").show();"NOK"==a("input[name=SENDING]").val()&&(b.preventDefault(),a("#presences tbody tr").each(function(){"none"==
this.style.display&&this.remove()}),a("input[name=SENDING]").val("OK"),a("#saisieEnfants").submit())});a("form#genFacture").on("submit",function(b){if("0"==a("input[name=submitable]").val()){if("suppr"==a("input[name=choix]:checked").val()){b.preventDefault();b=a("input[name=dateDebut]").val().split("-").reverse().join("/");let d=a("input[name=dateFin]").val().split("-").reverse().join("/");b=confirm(`Attention, vous allez supprimer toutes les facture pour la p\u00e9riode du ${b} au ${d}, \u00eates-vous s\u00fbr de vouloir poursuivre ?`);
console.log(b);if(0==b)return!1}a("input[name=submitable]").val("1");a("form#genFacture").submit()}})});